name: Compile Nibble Zero
on: 
  schedule:
    - cron: "0 10 * * *"
  workflow_dispatch:
jobs:
  build:
    # CRITICAL FIX 1: You MUST use ubuntu-22.04. 
    # 'ubuntu-latest' is now 24.04, which breaks the ESP32 tools (mklittlefs).
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      
      # CRITICAL FIX 2: Install libtinfo5. 
      # This only works on ubuntu-22.04 and is required for mklittlefs.
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libtinfo5

      - name: Get latest meshtastic version 
        id: latest_meshtastic_tag
        run: |
          result=$(curl -sL https://api.github.com/repos/meshtastic/firmware/releases/latest | jq -r '.tag_name' )
          echo "result=$result" >> $GITHUB_OUTPUT

      - name: Install platformIO cli
        run: |
          python3 -m pip install -U platformio
      
      - name: Install meshtastic firmware
        run: |
          git clone https://github.com/meshtastic/firmware /home/runner/meshtastic
      
      - name: Install PlatformIO Platforms
        run: |
          pio platform install espressif32
          
      - name: Move retia board files 
        run: |
          # Copy your variants into the firmware directory
          cp -r ${{ github.workspace }}/variants/retia-nibble/* /home/runner/meshtastic/variants/
          
          # Move board definition files if they exist
          mkdir -p /home/runner/meshtastic/boards
          find ${{ github.workspace }}/variants/retia-nibble/ -name "*.json" -exec cp {} /home/runner/meshtastic/boards/ \;
      
      - name: build
        run: |
          # Only target the specific board you need
          target="nibble-zero-connet"
          
          echo "Injecting custom environment for $target..."
          
          # CRITICAL FIX 3: Force the environment name to match the folder name.
          # We use sed to replace whatever [env:name] is in the file with [env:nibble-zero-connet]
          # This fixes the "UnknownEnvNamesError" caused by the typo mismatch.
          if [ -f "/home/runner/meshtastic/variants/$target/platformio.ini" ]; then
            echo "" >> /home/runner/meshtastic/platformio.ini
            sed "s/\[env:.*\]/[env:$target]/" "/home/runner/meshtastic/variants/$target/platformio.ini" >> /home/runner/meshtastic/platformio.ini
          else
            echo "Error: Could not find platformio.ini for $target"
            exit 1
          fi

          mkdir -p /home/runner/dists
          echo "----------------------------------------------------"
          echo "Building target: $target"
          echo "----------------------------------------------------"

          # FIX 4: Use Environment Variables to inject the variant path.
          # This allows the compiler to find 'variant.h' without modifying the INI file.
          export PLATFORMIO_BUILD_FLAGS="-I variants/$target"
          export PLATFORMIO_BOARD_BUILD_VARIANT="$target"

          pio run \
            --project-dir /home/runner/meshtastic/ \
            -e "$target"

          # Package the result
          build_dir="/home/runner/meshtastic/.pio/build/${target}"
          
          # Check if firmware.bin exists
          if [ -f "${build_dir}/firmware.bin" ]; then
            cd "${build_dir}"
            zip -j "/home/runner/dists/${target}.zip" *.bin
            echo "Build Success!"
          else
            echo "Build Failed: Firmware binary not found."
            exit 1
          fi

      - name: Upload binary to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: /home/runner/dists/*
          file_glob: true
          tag: ${{ steps.latest_meshtastic_tag.outputs.result }}
          overwrite: true
