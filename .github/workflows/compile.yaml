name: Compile Nibble Zero
on: 
  schedule:
    - cron: "0 10 * * *"
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y libtinfo5

      - name: Get latest meshtastic version 
        id: latest_meshtastic_tag
        run: |
          result=$(curl -sL https://api.github.com/repos/meshtastic/firmware/releases/latest | jq -r '.tag_name' )
          echo "result=$result" >> $GITHUB_OUTPUT

      - name: Install platformIO cli
        run: python3 -m pip install -U platformio
      
      - name: Install meshtastic firmware
        run: git clone https://github.com/meshtastic/firmware /home/runner/meshtastic
      
      # FIX 1: Explicitly install the tool so we can find it to patch it
      - name: Install PlatformIO Platforms and Tools
        run: |
          pio platform install espressif32
          # Force download the tool now so it exists on disk
          pio pkg install --global --tool "platformio/tool-mklittlefs"
      
      # FIX 2: Replace the broken 32-bit binary with a dummy script
      - name: Neutralize mklittlefs (Replace with Dummy)
        run: |
          # Find the mklittlefs binary
          TOOL_PATH=$(find /home/runner/.platformio/packages -name "mklittlefs" -type f | head -n 1)
          
          if [ -z "$TOOL_PATH" ]; then
            echo "Error: Could not find mklittlefs. Listing packages folder for debug:"
            ls -R /home/runner/.platformio/packages
            exit 1
          fi
          
          echo "Found tool at: $TOOL_PATH"
          echo "Replacing it with a dummy script..."
          
          rm "$TOOL_PATH"
          
          # Create a dummy script that satisfies PlatformIO
          cat << 'EOF' > "$TOOL_PATH"
          #!/bin/bash
          # Loop through args to find the output filename (last arg)
          for last; do true; done
          # Create a fake file there so the build continues
          echo "Dummy filesystem image" > "$last"
          exit 0
          EOF
          
          chmod +x "$TOOL_PATH"
          echo "mklittlefs has been neutralized."

      - name: Move retia board files 
        run: |
          cp -r ${{ github.workspace }}/variants/retia-nibble/nibble-zero-connet /home/runner/meshtastic/variants/
          mkdir -p /home/runner/meshtastic/boards
          find ${{ github.workspace }}/variants/retia-nibble/ -name "*.json" -exec cp {} /home/runner/meshtastic/boards/ \;
      
      - name: Build nibble-zero-connet
        run: |
          target="nibble-zero-connet"
          
          # Fix environment name mismatch in the ini file
          if [ -f "/home/runner/meshtastic/variants/$target/platformio.ini" ]; then
            echo "" >> /home/runner/meshtastic/platformio.ini
            sed "s/\[env:.*\]/[env:$target]/" "/home/runner/meshtastic/variants/$target/platformio.ini" >> /home/runner/meshtastic/platformio.ini
          else
            echo "Error: Could not find platformio.ini for $target"
            exit 1
          fi

          mkdir -p /home/runner/dists
          export PLATFORMIO_BUILD_FLAGS="-I variants/$target"
          export PLATFORMIO_BOARD_BUILD_VARIANT="$target"

          echo "Building target: $target"
          
          # Run build (This will now succeed because mklittlefs is faked)
          pio run --project-dir /home/runner/meshtastic/ -e "$target"

          # Package the result
          build_dir="/home/runner/meshtastic/.pio/build/${target}"
          if [ -f "${build_dir}/firmware.bin" ]; then
            echo "Build Success! Packaging..."
            cd "${build_dir}"
            zip -j "/home/runner/dists/${target}.zip" firmware.bin
          else
            echo "Build Failed: firmware.bin not found."
            exit 1
          fi

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.latest_meshtastic_tag.outputs.result }}
          release_name: Retia binaries for Meshtastic ${{ steps.latest_meshtastic_tag.outputs.result }}
          body: |
            Compiled nibble-zero-connet using meshtastic release ${{ steps.latest_meshtastic_tag.outputs.result }}
          draft: false
          prerelease: false

      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: /home/runner/dists/*
          file_glob: true
          tag: ${{ steps.latest_meshtastic_tag.outputs.result }}
