name: Compile 
on: 
  schedule:
    - cron: "0 10 * * *"
  workflow_dispatch:
jobs:
  build:
    # KEEP THIS: ubuntu-22.04 is required for the ESP32 build tools
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y libtinfo5

      - name: Get latest meshtastic version 
        id: latest_meshtastic_tag
        run: |
          result=$(curl -sL https://api.github.com/repos/meshtastic/firmware/releases/latest | jq -r '.tag_name' )
          echo "result=$result" >> $GITHUB_OUTPUT

      - name: Check if release exists locally
        id: check_release
        env: 
          RELEASE_TAG: ${{ steps.latest_meshtastic_tag.outputs.result }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: | 
          set -e
          if gh release view "$RELEASE_TAG" >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "Release $RELEASE_TAG exists."
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "Release $RELEASE_TAG does not exists."
          fi

      - name: Exit if release already exists
        if: steps.check_release.outputs.exists == 'true'
        run: | 
          echo "Release for this version of meshtastic already exists. Exiting."
          exit 1

      - name: Install platformIO cli
        run: |
          python3 -m pip install -U platformio
      
      - name: Install meshtastic firmware
        run: |
          git clone https://github.com/meshtastic/firmware /home/runner/meshtastic
      
      - name: Install PlatformIO Platforms
        run: |
          pio platform install espressif32
          
      - name: Move retia board files 
        run: |
          # Move variant folders
          cp -r ${{ github.workspace }}/variants/retia-nibble/* /home/runner/meshtastic/variants/
          
          # FIX 5: Also move any board definition JSON files if they exist
          # This is critical if your variants use custom board definitions
          mkdir -p /home/runner/meshtastic/boards
          find ${{ github.workspace }}/variants/retia-nibble/ -name "*.json" -exec cp {} /home/runner/meshtastic/boards/ \;
      
      - name: build
        continue-on-error: true
        run: |
          set +e
          
          mkdir -p /home/runner/dists
          : > build_status.env

          shopt -s nullglob

          targets=(
            nibble-connect
            nibble-esp32
            nibble-rp2040
            nibble-screen-connect
            nibble-zero-connet
            nugget-bluetooth-rmf95
          )
          
          echo "Injecting custom environments..."
          for target in "${targets[@]}"; do
            if [ -f "/home/runner/meshtastic/variants/$target/platformio.ini" ]; then
              echo "Merging config for $target"
              echo "" >> /home/runner/meshtastic/platformio.ini
              cat "/home/runner/meshtastic/variants/$target/platformio.ini" >> /home/runner/meshtastic/platformio.ini
              
              # FIX 6: Force the compiler to look in the custom variant folder
              # This solves "fatal error: variant.h: No such file"
              echo "build_flags = \${env.build_flags} -I variants/$target" >> /home/runner/meshtastic/platformio.ini
              echo "-L variants/$target" >> /home/runner/meshtastic/platformio.ini
            fi
          done

          for target in "${targets[@]}"; do
            echo "----------------------------------------------------"
            echo "Building target: $target"
            echo "----------------------------------------------------"

            pio run \
              --project-dir /home/runner/meshtastic/ \
              -e "$target"

            status=$?
            
            if [ $status -eq 0 ]; then
              echo "$target=success" >> build_status.env
                
              build_dir="/home/runner/meshtastic/.pio/build/${target}"
              bin_files=("${build_dir}"/*.bin)
              
              if [ ${#bin_files[@]} -eq 0 ]; then
                echo "No bins found for $target, skipping archive"
                continue
              fi
              
              (
                cd "${build_dir}"
                tar -cvf "/home/runner/dists/${target}.tar" ./*.bin >/dev/null 2>&1
              )

              zip -j "/home/runner/dists/${target}.zip" "${bin_files[@]}" >/dev/null 2>&1
              echo "Successfully archived $target"

            else
              echo "FAILED to build $target"
              echo "$target=failure" >> build_status.env
            fi
          done 

          echo "Build summary: "
          cat build_status.env || echo "No status file"
          
          if ! grep -q '=success' build_status.env; then
            echo "All builds have failed."
            exit 1
          fi

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.latest_meshtastic_tag.outputs.result }}
          release_name: Retia binaries for Meshtastic ${{ steps.latest_meshtastic_tag.outputs.result }}
          body: |
            Compiled versions of [meshtastic](https://github.com/meshtastic/firmware) for use with retia boards, compiled using meshtastic release ${{ steps.latest_meshtastic_tag.outputs.result }}
          draft: false
          prerelease: false

      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: /home/runner/dists/*
          file_glob: true
          tag: ${{ steps.latest_meshtastic_tag.outputs.result }}
